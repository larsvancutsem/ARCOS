---
title: "ARCOS WashPost - US Opioids"
author: "Lars VC"
date: "11-1-2021"
output: rmarkdown::github_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this R Markdown document (made using Shiny), we showcase the evolution of opioid transactions by US county, over time, retrieved from the ARCOS dataset. The Washington Post gained access to the Drug Enforcement Administrationâ€™s Automation of Reports and Consolidated Orders System, known as ARCOS, as the result of a court order. The Post and HD Media, which publishes the Charleston Gazette-Mail in West Virginia, waged a year-long legal battle for access to the database, which the government and the drug industry had sought to keep secret.

Here are the links to the articles on the [lobbying efforts targeted towards the DEA](https://www.washingtonpost.com/graphics/2017/investigations/dea-drug-industry-congress/?tid=graphics-story), the [legal battle to obtain access to the data](https://www.washingtonpost.com/health/how-an-epic-legal-battle-brought-a-secret-drug-database-to-light/2019/08/02/3bc594ce-b3d4-11e9-951e-de024209545d_story.html) and the [follow-up reporting](https://www.washingtonpost.com/national/2019/08/12/post-released-deas-data-pain-pills-heres-what-local-journalists-are-using-it/) on the ARCOS dataset.

The data are available in [unfiltered format](https://wpinvestigative.github.io/arcos/#download-the-raw-data), as well as via a public [RESTful API](https://wpinvestigative.github.io/arcos/).

# Embedded Application

```{r, echo=F}
# US geographical data

counties <- urbnmapr::counties
states <- urbnmapr::states

# set up db connection
db <- dbConnect(RSQLite::SQLite(), "washpo.db")

shinyApp(
  ui <- fluidPage(
    titlePanel("ARCOS Wash Post Dataset"),
    sidebarLayout(
      sidebarPanel(
        sliderInput(inputId = "year",
                    label = "Specify year:",
                    min = 2006,
                    max = 2014,
                    value = 2006),
        sliderInput(inputId = "month",
                    label = "Specify month:",
                    min = 1,
                    max = 12,
                    value = 1),
        checkboxInput(inputId = "popscale", 
                      label = "Scale by population:", 
                      value = FALSE, 
                      width = NULL),
        selectInput(inputId = "columns",
                    label = "Specify states:",
                    choices = unique(states$state_name),
                    selected = "Florida",
                    multiple = TRUE)
      ),
      mainPanel(
        plotOutput(outputId = "distPlot", width='100%', height="400px")
      )
    )
  ),
  
  
  server <- function(input, output) {
    output$distPlot <- renderPlot({
      
      year <- input$year
      month <- input$month
      scale <- input$popscale
      columns <- input$columns
    
    query <- paste0("select * from data where year == '", year, "' and month == '", sprintf("%02d", month), "';")
    message(paste0(year, " - ", month))
    temp <- dbGetQuery(db, query)
    names(temp)[7] <- "county_fips"
    
    data <- left_join(temp, counties, by = "county_fips") %>% 
      filter(BUYER_STATE %in% states$state_abbv[states$state_name %in% columns])
    agg.data <- aggregate(cbind(long, lat, group, DOSAGE_UNIT, population) ~ state_name, data = data, mean)

    
    if(scale){
      data$DOSAGE_UNIT <- data$DOSAGE_UNIT/data$population
    }
    
    data %>%
      ggplot(aes(long, lat, group = group, fill = DOSAGE_UNIT)) +
      geom_polygon(color = "#ffffff", size=.05) +
      scale_fill_gradient(guide = guide_colorbar(title.position = "top"),
                          low = "#ffffff", high = "#ff6961") +
      geom_polygon(data = states[states$state_abbv %in% data$BUYER_STATE, ], 
                   mapping = aes(long, lat, group = group),
                   fill = NA, color = "black", size=.5) +
      geom_label(data = agg.data, aes(long, lat, label = state_name), size = 5, 
                 fontface = "bold", fill="#ffffff") +
      coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
      theme(legend.title = element_text(),
            legend.key.width = unit(.5, "in")) +
      labs(fill = "Units") +
      ggtitle("US Opioids") +
      theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
                                            size = 0.5), 
            panel.background = element_rect(fill = "aliceblue"))
      
    })
  }, 
  options = list(height = 1000)
)
```
